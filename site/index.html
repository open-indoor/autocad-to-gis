<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>cad2gis</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"" />

    <script src=" https://unpkg.com/@turf/turf@6.5.0/turf.min.js">
    </script>
    <script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="css/github-fork-ribbon.css" rel="stylesheet" />
    <link href="css/menu.css" rel="stylesheet" />
    <link href="css/filter.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: -1
        }
    </style>
</head>

<body>
    <!-- <svg class="bi bi-exclamation-triangle text-success" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"
        xmlns="http://www.w3.org/2000/svg">
    </svg> -->
    <!-- <label class="form-label">
        <img src="https://icons.getbootstrap.com/assets/icons/cloud-arrow-up.svg" width="32" height="32">
        <input type="file" id="file-upload" accept="application/geo+json,application/vnd.geo+json,.geojson" hidden />
    </label> -->

    <!-- <div class="dropdown">
        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton1"
            data-bs-toggle="dropdown" aria-expanded="false">
            <img src="img/dwg.svg" width="36" height="36">
        </button>

        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
        </ul>
    </div> -->
    <div class="btn-group dropend">
        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false" style="padding: 0px 5px">
            <i class="bi bi-folder" style="font-size: 2rem; color: white;"></i>
        </button>
        <ul class="dropdown-menu bg-dark" style="min-width: 0px;  padding: 0px 0px; width: 250px;">
            <li>
                <label class="dropdown-item" style="padding: 0.5rem 0.5rem;">
                    <img src="img/dwg.svg" width="36" height="36" style="float: left; "><a
                        style="color: white;">&nbsp;-&nbsp;Import AutoCAD file...</a>
                    <input type="file" id="file-cad-upload" accept="application/acad,application/dxf,.dxf,.dwg"
                        hidden />
                </label>
            </li>
            <li>
                <label class="dropdown-item" style="padding: 0.5rem 0.5rem;">
                    <img src="img/geojson-file.svg" width="36" height="36" style="float: left; "><a
                        style="color: white;">&nbsp;-&nbsp;Open GeoJSON file...</a>
                    <input type="file" id="file-geo-upload"
                        accept="application/geo+json,application/vnd.geo+json,.geojson" hidden />
                </label>
            </li>
            <li>
                <label class="dropdown-item disabled" style="padding: 0.5rem 0.5rem;" onclick="onDownload()">
                    <img src="img/cloud-arrow-down.svg" width="36" height="36" style="float: left; ">
                    <a style="color: white;" type="application/geo+json" download>&nbsp;-&nbsp;Save as GeoJSON</a>
                </label>
            </li>
        </ul>
    </div>
    <br />

    <div class="btn-group dropend">
        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false" style="padding: 0px 5px">
            <i class="bi bi-gear" style="font-size: 2rem; color: white;"></i>
        </button>
        <ul class="dropdown-menu bg-dark" style="min-width: 0px; padding: 0px 0px; width: 250px;">
            <li>
                <label class="dropdown-item disabled" style="padding: 0.5rem 0.5rem;">
                    <img src="img/geo-fill.svg" width="36" height="36" style="float: left; ">
                    <a style="color: white;">&nbsp;-&nbsp;Move whole plan</a>
                </label>
            </li>
        </ul>
    </div>

    <!-- <div class="icon-bar">
        <label>
            <img src="img/dwg.svg" width="36" height="36">
            <input type="file" id="file-cad-upload" accept=accept="application/acad,application/dxf,.dxf,.dwg" hidden />
        </label>
        <label>
            <img src="img/geojson-file.svg" width="36" height="36">
            <input type="file" id="file-geo-upload" accept="application/geo+json,application/vnd.geo+json,.geojson"
                hidden />
        </label>
        <a>
            <i class="bi bi-cloud-arrow-down" style="font-size: 1.6rem; color: white;" onclick="onDownload()"></i>
        </a>
    </div> -->
    <!-- <div class="spinner-border text-success" role="status" style="z-index: 2">
        &nbsp;&nbsp;Loading...
    </div> -->
    <div id="spinner" class="d-flex justify-content-center spinner" style="display: none;visibility: hidden;">
        <button class="btn btn-primary" type="button" disabled>
            <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
            Loading CAD file...
        </button>
    </div>

    <!-- <label>
        <img src="my-image.png">
        <input type="file" name="myfile" style="display:none">
    </label> -->

    <!-- <div class="icon-bar">
        <label><a class="active"><i class="bi bi-cloud-upload"><input type="file" id="file-upload" name="file"
                        accept="application/geo+json,application/vnd.geo+json,.geojson" hidden></i></a></label>
        <a href="#"><i class="bi bi-cloud-download"></i></a>



    </div> -->
    <!-- accept="application/acad,application/dxf,.dxf,.dwg"  -->

    <div class="github-fork-ribbon-wrapper right">
        <div class="github-fork-ribbon">
            <!--from http://simonwhitaker.github.com/github-fork-ribbon-css/ -->
            <a href="https://github.com/open-indoor/autocad-to-gis">Fork me on GitHub</a>
        </div>
    </div>
    <!-- <a href="https://github.com/you"><img loading="lazy" width="149" height="149"
            src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149"
            class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a> -->
    <div id="map"></div>
    <nav id="filter-group" class="filter-group"></nav>
    <pre id="coordinates" class="coordinates"></pre>

    <!-- <label class="btn btn-default">
        Browse <input type="file" hidden>
    </label> -->

    <!-- <input type="file" id="file" name="file" accept="application/geo+json,application/vnd.geo+json,.geojson" /> -->
    <!-- <input type="file" id="file-upload" name="file" accept="application/acad,application/dxf,.dxf,.dwg" /> -->
    <script>
        let spinner = document.getElementById("spinner");
        let geoFileName = 'cad2gis.geojson'
        let cadFileName = 'cad2gis.dwg'
        let initPos = undefined;
        let initDistance = undefined;
        let bboxDistance = undefined;
        let newPos = undefined;
        let shiftPos = { lng: 0, lat: 0 };
        let shiftBearing = 0;
        let shiftScale = 1.0;
        let scalingPoint = undefined;
        let plan = undefined;
        let shiftPlan = {
            "type": "FeatureCollection",
            "features": []
        };
        // let translatedRotatedPlan = undefined;
        let bboxPlan = undefined;
        let shiftBboxPlan = undefined;
        // let translatedRotatedBboxPlan = undefined;
        // let onMove_ = undefined;
        let currentLayerID = undefined;
        // let onMoveUp_ = undefined;
        let filterGroup = document.getElementById('filter-group');
        var coordinates = document.getElementById('coordinates');
        var map = new maplibregl.Map({
            container: 'map',
            style: {
                "id": "raster",
                "version": 8,
                "name": "Raster tiles",
                "center": [0, 0],
                "zoom": 0,
                "sources": {
                    "raster-tiles": {
                        "type": "raster",
                        "tiles": [
                            "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        ],
                        "tileSize": 256,
                        "minzoom": 0,
                        "maxzoom": 19
                    }
                },
                "layers": [{
                    "id": "background",
                    "type": "background",
                    "paint": {
                        "background-color": "#e0dfdf"
                    }
                }, {
                    "id": "simple-tiles",
                    "type": "raster",
                    "source": "raster-tiles"
                }]
            }, center: [-8.3226655, 53.7654751],
            zoom: 8,
            hash: true
        });

        var canvas = map.getCanvasContainer();
        scalingPoint = {
            'type': 'FeatureCollection',
            'features': [
                {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [0, 0]
                    }
                }
            ]
        };

        var nav = new maplibregl.NavigationControl();
        map.addControl(nav, 'bottom-right');
        var scale = new maplibregl.ScaleControl({
            // maxWidth: 80,
            // unit: 'imperial'
        });
        map.addControl(scale);
        // scale.setUnit('metric');


        function initData(plan_) {
            plan = plan_;

            let turf_bbox = turf.bbox(plan);
            bboxPlan = turf.bboxPolygon(turf_bbox);
            console.log('bboxPlan:', bboxPlan);
            // console.log('bbox_poly:', bbox_poly);
            // plan.features.push(bbox_poly);

            shiftPlan = turf.clone(plan);
            shiftBboxPlan = turf.clone(bboxPlan);
            // translatedRotatedPlan = rotatedPlan;
            // translatedRotatedBboxPlan = rotatedBboxPlan;
            // console.log('bbox:', bbox);
            let bbox = [[turf_bbox[0], turf_bbox[1]], [turf_bbox[2], turf_bbox[3]]];

            // let bb_ = rotatedPlan.features.filter(feature => {
            //     return feature.properties.Layer === 'oid_bbox'
            // })[0];
            // console.log('bb_:', bb_);
            scalingPoint.features[0].geometry.coordinates = [
                bboxPlan.geometry.coordinates[0][0][0],
                bboxPlan.geometry.coordinates[0][0][1]
            ];

            let center_ = turf.center(shiftPlan);
            let point_ = scalingPoint.features[0];
            bboxDistance = turf.distance(center_, point_);

            // map.getSource('point').setData(scalingPoint);
            // scalingPoint.features[0].geometry.coordinates = [turf_bbox[0], turf_bbox[3]];

            let newCameraTransform = map.cameraForBounds(bbox, {
                padding: { top: 10, bottom: 25, left: 15, right: 5 }
            });
            console.log('newCameraTransform:', newCameraTransform);
            // let geojson_center = turf.centroid(plan);
            // let center = geojson_center.geometry.coordinates
            // map.setCenter(newCameraTransform.center);
            // map.setZoom(newCameraTransform.zoom);

            map.flyTo({
                center: newCameraTransform.center,
                zoom: newCameraTransform.zoom,
                pitch: 0,
                bearing: 0,
                speed: 5.0
            });

            // Add as source to the map
            map.addSource('uploaded-source', {
                'type': 'geojson',
                'data': plan
            });

            map.addSource('oid-bbox', {
                'type': 'geojson',
                'data': bboxPlan
            });

            map.addLayer({
                'id': 'oid_bbox',
                'type': 'line',
                'source': 'oid-bbox',
                'paint': {
                    'line-color': '#F00',
                    'line-width': 3,
                },
                'filter': [
                    "all",
                    ['==', '$type', 'Polygon']
                ]
            });

            // Add a single point to the map
            map.addSource('point', {
                'type': 'geojson',
                'data': scalingPoint
            });

            map.addLayer({
                'id': 'point',
                'type': 'circle',
                'source': 'point',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#3887be'
                }
            });

            // When the cursor enters a feature in the point layer, prepare for dragging.
            map.on('mouseenter', 'point', function () {
                map.setPaintProperty('point', 'circle-color', '#3bb2d0');
                canvas.style.cursor = 'move';
            });

            map.on('mouseleave', 'point', function () {
                map.setPaintProperty('point', 'circle-color', '#3887be');
                canvas.style.cursor = '';
            });

            map.on('mousedown', 'point', function (e) {
                // Prevent the default map drag behavior.
                e.preventDefault();

                canvas.style.cursor = 'grab';

                map.on('mousemove', onMovePoint);
                map.once('mouseup', onMoveUpPoint);
            });

            map.on('touchstart', 'point', function (e) {
                if (e.points.length !== 1) return;

                // Prevent the default map drag behavior.
                e.preventDefault();

                map.on('touchmove', onMovePoint);
                map.once('touchend', onMoveUpPoint);
            });

            // Add Layer list
            plan.features.forEach(function (feature) {
                let layerID = feature.properties['Layer'];
                if (layerID === 'oid_bbox') {
                    return;
                }
                // var layerID = layer;

                // Add a layer for this symbol type if it hasn't been added already.
                if (!map.getLayer(layerID)) {

                    map.addLayer({
                        'id': layerID,
                        'type': 'fill',
                        'source': 'uploaded-source',
                        'paint': {
                            'fill-color': '#888888',
                            'fill-outline-color': 'red',
                            'fill-opacity': 0.4
                        },
                        'filter': [
                            "all",
                            ['==', '$type', 'Polygon'],
                            ['==', 'Layer', layerID]
                        ]
                    });

                    // Add checkbox and label elements for the layer.
                    var input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = layerID;
                    input.checked = true;
                    filterGroup.appendChild(input);

                    var label = document.createElement('label');
                    label.setAttribute('for', layerID);
                    label.textContent = layerID;
                    filterGroup.appendChild(label);

                    // When the checkbox changes, update the visibility of the layer.
                    input.addEventListener('change', function (e) {
                        map.setLayoutProperty(
                            layerID,
                            'visibility',
                            e.target.checked ? 'visible' : 'none'
                        );
                    });

                    map.on('mouseenter', layerID, function () {
                        // map.setPaintProperty('point', 'circle-color', '#3bb2d0');
                        canvas.style.cursor = 'move';
                        map.setPaintProperty(layerID, 'fill-color', '#00F')
                    });

                    map.on('mouseleave', layerID, function () {
                        // map.setPaintProperty('point', 'circle-color', '#3887be');
                        canvas.style.cursor = '';
                        map.setPaintProperty(layerID, 'fill-color', '#888888')

                    });

                    map.on('rotatestart', function (e) {
                        if (map.dragRotate.isActive() || map.touchZoomRotate.isActive()) {
                            console.log('rotatestart');
                            map.on('rotate', onRotate);
                            map.once('rotateend', onRotateEnd);
                        }
                    });

                    map.on('mousedown', layerID, function (e) {
                        currentLayerID = layerID;
                        // onMoveUp_ = (e) => onMoveUp(e, layerID);
                        // Prevent the default map drag behavior.
                        e.preventDefault();

                        canvas.style.cursor = 'grab';

                        map.on('mousemove', onMove);
                        map.once('mouseup', onMoveUp);
                    });

                    map.on('touchstart', layerID, function (e) {
                        currentLayerID = layerID;
                        // onMoveUp_ = (e) => onMoveUp(e, layerID);
                        if (e.points.length !== 1) return;

                        // Prevent the default map drag behavior.
                        e.preventDefault();

                        map.on('touchmove', onMove);
                        map.once('touchend', onMoveUp);
                    });
                }
            })
        }
        function handleCadSelect(evt) {
            var file = evt.target.files[0]; // Read first selected file
            console.log('cad file:', file);
            cadFileName = file.name;


            var data = new FormData()
            data.append('file', file)


            // var reader = new FileReader();

            // reader.onload = function (event) {
            //     console.log('event:', event);
            // console.log(reader.result);
            let center = map.getCenter();
            let lng = center.lng;
            let lat = center.lat;

            spinner.style.display = "block";
            spinner.style.visibility = "visible";
            fetch("/api/autocad-to-gis/convert/" + lng + "/" + lat, {
                method: "POST",
                body: data
            }).then((response) => response.json())
                .then((result) => {
                    console.log('Success:', result);
                    initData(result)
                })
                .catch((error) => {
                    console.error('Error:', error);
                })
                .finally(function () {
                    spinner.style.display = "none";
                    spinner.style.visibility = "hidden";
                });
            ;
            // }
            // reader.readAsBinaryString(file);

        }
        function handleGeojsonSelect(evt) {
            var file = evt.target.files[0]; // Read first selected file
            console.log('geojson file:', file);
            geoFileName = file.name;
            var reader = new FileReader();

            reader.onload = function (theFile) {
                // Parse as (geo)JSON
                // Call to api converter
                console.log('theFile:', theFile);
                // const payload = new FormData();
                // payload.append('CV', file, 'CV.pdf');
                // payload.append('First name', document.getElementById('firstName').value);
                // payload.append('Last name', document.getElementById('lastName').value);
                // fetch("https://autocad-to-geojson.openindoor.io/api/autocad-to-gis/convert", {
                //     method: "POST",
                // })

                let plan_ = JSON.parse(theFile.target.result);

                initData(plan_)

            };

            // Read the GeoJSON as text
            reader.readAsText(file, 'UTF-8');
        }

        document
            .getElementById('file-geo-upload')
            .addEventListener('change', handleGeojsonSelect, false);

        document
            .getElementById('file-cad-upload')
            .addEventListener('change', handleCadSelect, false);


        function DIST_BEAR(point_01, point_02) {
            var from = turf.point([point_01.lng, point_01.lat]);
            var to = turf.point([point_02.lng, point_02.lat]);
            var distance = turf.distance(from, to);

            var point1 = turf.point([point_01.lng, point_01.lat]);
            var point2 = turf.point([point_02.lng, point_02.lat]);
            var bearing = turf.bearing(point1, point2);
            return { distance, bearing };
        }

        function displayShift(shiftBearing_, shiftScale_, shiftPos_) {
            coordinates.style.display = 'block';
            coordinates.innerHTML =
                'Shift:<ul>' +
                '<li>Rotation: ' + (shiftBearing_) + '</li>' +
                '<li>Scale: ' + (shiftScale_) + '</li>' +
                '<li>Longitude: ' + (shiftPos_.lng) + '</li>' +
                '<li>Latitude: ' + (shiftPos_.lat) + '</li></ul>';
            canvas.style.cursor = '';
        }

        function updateShift() {
            // Translation
            let { distance, bearing } = DIST_BEAR({ lng: 0, lat: 0 }, shiftPos);
            let translatedPlan = turf.transformTranslate(plan, distance, bearing)
            let translatedBboxPlan = turf.transformTranslate(bboxPlan, distance, bearing)
            // Rotation
            let center_ = turf.getCoord(turf.center(translatedPlan));
            let rotatedPlan = turf.transformRotate(translatedPlan, shiftBearing, { pivot: center_ })
            let rotatedBboxPlan = turf.transformRotate(translatedBboxPlan, shiftBearing, { pivot: center_ })
            // Scaling
            shiftPlan = turf.transformScale(rotatedPlan, shiftScale, { 'origin': center_ });
            shiftBboxPlan = turf.transformScale(rotatedBboxPlan, shiftScale, { 'origin': center_ });

            scalingPoint.features[0].geometry.coordinates = turf.getCoords(shiftBboxPlan)[0][0];

            map.getSource('uploaded-source').setData(shiftPlan);
            map.getSource('oid-bbox').setData(shiftBboxPlan);
            map.getSource('point').setData(scalingPoint);
        }

        function onRotate(e) {
            if (map.dragRotate.isActive() || map.touchZoomRotate.isActive()) {
                console.log('onRotate');
                let center_ = turf.center(shiftPlan);
                map.getSource('uploaded-source').setData(turf.transformRotate(shiftPlan, map.getBearing(), { pivot: center_.geometry.coordinates }));
                map.getSource('oid-bbox').setData(turf.transformRotate(shiftBboxPlan, map.getBearing(), { pivot: center_.geometry.coordinates }));
            }
        }

        function onRotateEnd(e) {
            console.log('onRotateEnd');
            shiftBearing = shiftBearing + map.getBearing();
            updateShift();

            map.flyTo({
                center: map.getCenter(),
                zoom: map.getZoom(),
                pitch: 0,
                bearing: 0,
                speed: 5.0
            });

            displayShift(shiftBearing, shiftScale, shiftPos)
        }

        function onMove(e) {
            if (initPos == null) {
                initPos = e.lngLat;
                console.log('onMove', currentLayerID, 'initPos:', initPos);
            }
            newPos = e.lngLat;

            // Set a UI indicator for dragging.
            canvas.style.cursor = 'grabbing';

            let pos = {
                lng: newPos.lng - initPos.lng,
                lat: newPos.lat - initPos.lat
            }
            let { distance, bearing } = DIST_BEAR({ lng: 0, lat: 0 }, pos);

            let layerData = {
                "type": "FeatureCollection",
                "features": []
            }
            layerData.features = shiftPlan.features.filter((feature) => {
                return feature.properties.Layer === currentLayerID
            });
            map.getSource('uploaded-source').setData(turf.transformTranslate(layerData, distance, bearing));
            map.getSource('oid-bbox').setData(turf.transformTranslate(shiftBboxPlan, distance, bearing));

        }

        function onMoveUp(e) {
            currentLayerID = null;
            if (initPos != null) {
                shiftPos = {
                    lng: shiftPos.lng + newPos.lng - initPos.lng,
                    lat: shiftPos.lat + newPos.lat - initPos.lat
                }
                updateShift()
                initPos = null;
                // Print the coordinates of where the point had finished being dragged to on the map.
                displayShift(shiftBearing, shiftScale, shiftPos)
            }

            // Unbind mouse/touch events
            map.off('mousemove', onMove);
            map.off('touchmove', onMove);
        }

        function onMovePoint(e) {
            // Set a UI indicator for dragging.
            canvas.style.cursor = 'grabbing';

            var coords = e.lngLat;
            scalingPoint.features[0].geometry.coordinates = [coords.lng, coords.lat];
            if (initDistance == null) {
                let center_ = turf.center(shiftPlan);
                let point_ = scalingPoint.features[0];
                initDistance = turf.distance(center_, point_);
            }

            let center_ = turf.center(shiftPlan);
            let point_ = scalingPoint.features[0];
            let distance_ = turf.distance(center_, point_);

            let shiftScale_ = (distance_ / initDistance);

            map.getSource('uploaded-source').setData(turf.transformScale(shiftPlan, shiftScale_, { 'origin': center_.geometry.coordinates }));
            map.getSource('oid-bbox').setData(turf.transformScale(shiftBboxPlan, shiftScale_, { 'origin': center_.geometry.coordinates }));

            // Update the Point feature in `geojson` coordinates
            // and call setData to the source layer `point` on it.
            map.getSource('point').setData(scalingPoint);
        }

        function onMoveUpPoint(e) {
            var coords = e.lngLat;

            // Print the coordinates of where the point had finished being dragged to on the map.
            let center_ = turf.center(shiftPlan);
            let point_ = scalingPoint.features[0];
            let distance_ = turf.distance(center_, point_);
            shiftScale = (distance_ / bboxDistance);
            displayShift(shiftBearing, shiftScale, shiftPos)
            updateShift();
            initDistance = null;
            // Unbind mouse/touch events
            map.off('mousemove', onMovePoint);
            map.off('touchmove', onMovePoint);
        }

        map.on('load', function () {
            map.setBearing(0);
        });

        function onDownload() {
            download(JSON.stringify(shiftPlan), geoFileName, "application/geo+json");
        }
        function download(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }
    </script>

</body>

</html>